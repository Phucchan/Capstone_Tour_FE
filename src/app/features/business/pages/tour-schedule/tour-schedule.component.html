<div class="container mx-auto p-4 sm:p-6 lg:p-8">
  <!-- Header -->
  <ng-container *ngIf="tourDetail$ | async as tour">
    <nz-page-header [nzTitle]="'Xây dựng Lịch trình'" [nzSubtitle]="tour.name" (nzBack)="goBack()">
      <nz-page-header-extra>
        <a [routerLink]="['/business/tours', tourId]" nz-button>Về trang chi tiết</a>
        <button nz-button nzType="primary" (click)="openAddModal()">
          <span nz-icon nzType="plus"></span>
          Thêm ngày mới
        </button>
      </nz-page-header-extra>
    </nz-page-header>
  </ng-container>

  <!-- Loading Spinner -->
  <nz-spin [nzSpinning]="isLoading">
    <!-- Content -->
    <ng-container *ngIf="tourDays$ | async as days">
      <!-- Trường hợp chưa có ngày nào -->
      <div *ngIf="days.length === 0" class="mt-4">
        <nz-empty nzNotFoundContent="Chưa có ngày nào trong lịch trình. Hãy bắt đầu bằng cách nhấn nút 'Thêm ngày mới'." />
      </div>

      <!-- Hiển thị danh sách các ngày -->
      <div *ngIf="days.length > 0" class="mt-4 space-y-4">
        <nz-card *ngFor="let day of days" [nzActions]="[actionEdit, actionDelete]">
          <ng-template #actionEdit>
            <button nz-button nzType="text" (click)="openEditModal(day)">
              <span nz-icon nzType="edit"></span> Sửa
            </button>
          </ng-template>
          <ng-template #actionDelete>
            <button nz-button nzType="text" nzDanger nz-popconfirm nzPopconfirmTitle="Bạn có chắc chắn muốn xóa ngày này?" (nzOnConfirm)="handleDelete(day)">
              <span nz-icon nzType="delete"></span> Xóa
            </button>
          </ng-template>

          <nz-card-meta
            [nzTitle]="titleTemplate"
            [nzDescription]="descriptionTemplate"
          ></nz-card-meta>

          <ng-template #titleTemplate>
            <div class="flex items-center">
              <span class="font-bold text-lg">Ngày {{ day.dayNumber }}: {{ day.title || "Chưa có tiêu đề" }}</span>
              <span *ngIf="day.location" class="ml-4 text-sm font-normal text-gray-500">
                <span nz-icon nzType="environment" nzTheme="outline"></span>
                {{ day.location.name }}
              </span>
            </div>
          </ng-template>

          <ng-template #descriptionTemplate>
            <div class="mt-3" *ngIf="day.services && day.services.length > 0">
              <span class="text-sm font-semibold text-gray-600">Dịch vụ:</span>
              <div class="flex flex-wrap gap-2 mt-1">
                <nz-tag *ngFor="let service of day.services" nzColor="green">
                  {{ service.name }}
                </nz-tag>
              </div>
            </div>
          </ng-template>
        </nz-card>
      </div>
    </ng-container>
  </nz-spin>
</div>

<!-- Modal chứa Form Component -->
<nz-modal
  [(nzVisible)]="isModalOpen"
  [nzTitle]="modalTitle"
  (nzOnCancel)="closeModal()"
  [nzFooter]="null"
  [nzWidth]="'700px'"
  [nzMaskClosable]="false"
>
  <ng-container *nzModalContent>
    <!-- Component form được đặt bên trong modal -->
    <app-tour-day-form
      *ngIf="isModalOpen"
      [dayData]="currentDayToEdit"
      [tourId]="tourId"
      (formSaved)="handleFormSave()"
      (close)="closeModal()"
    ></app-tour-day-form>
  </ng-container>
</nz-modal>
