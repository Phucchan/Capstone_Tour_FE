
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
  <nz-page-header [nzTitle]="pageTitle" (nzBack)="goBack()">
    <nz-page-header-extra>
      <!-- ... các button khác ... -->
      <button form="tourForm" type="submit" nz-button nzType="primary" [nzLoading]="isSubmitting" [disabled]="tourForm.invalid">
        <span nz-icon nzType="save"></span>
        {{ isEditMode ? 'Lưu thay đổi' : 'Lưu & Tiếp tục' }}
      </button>
    </nz-page-header-extra>
  </nz-page-header>

  <nz-spin [nzSpinning]="isLoading">
    <ng-container *ngIf="tourOptions$ | async as options">
      <form nz-form id="tourForm" [formGroup]="tourForm" (ngSubmit)="onSubmit()">
        <div nz-row [nzGutter]="[24, 24]">
          <!-- Cột chính -->
          <div nz-col nzXs="24" nzLg="16">
            <!-- ... Các trường form cơ bản ... -->
            <nz-card>
              <!-- Tên Tour -->
              <nz-form-item>
                <nz-form-label nzRequired>Tên Tour</nz-form-label>
                <nz-form-control nzErrorTip="Vui lòng nhập tên tour">
                  <input nz-input formControlName="name" placeholder="Ví dụ: Khám phá Hà Giang 3 ngày 2 đêm" />
                </nz-form-control>
              </nz-form-item>

              <!-- Upload Ảnh -->
              <nz-form-item>
                <nz-form-label>Ảnh đại diện</nz-form-label>
                <nz-form-control>
                  <nz-upload nzListType="picture-card" [nzFileList]="fileList" [nzBeforeUpload]="beforeUpload" [nzShowUploadList]="{ showPreviewIcon: false }">
                    <div *ngIf="!imagePreview">
                      <span nz-icon nzType="plus"></span>
                      <div class="ant-upload-text">Tải ảnh lên</div>
                    </div>
                    <img *ngIf="imagePreview" [src]="imagePreview" class="w-full h-full object-cover" alt="Preview" />
                  </nz-upload>
                </nz-form-control>
              </nz-form-item>

              <!-- Loại Tour -->
              <nz-form-item>
                <nz-form-label nzRequired>Loại Tour</nz-form-label>
                <nz-form-control>
                  <nz-radio-group formControlName="tourType">
                    <label nz-radio nzValue="FIXED">Tour cố định (FIXED)</label>
                    <label nz-radio nzValue="CUSTOM">Tour theo yêu cầu (CUSTOM)</label>
                  </nz-radio-group>
                </nz-form-control>
              </nz-form-item>

              <!-- Mô tả -->
              <nz-form-item>
                <nz-form-label>Mô tả chi tiết</nz-form-label>
                <nz-form-control>
                  <textarea nz-input formControlName="description" placeholder="Nhập mô tả chi tiết, lịch trình sơ lược..." [nzAutosize]="{ minRows: 8, maxRows: 15 }"></textarea>
                </nz-form-control>
              </nz-form-item>
            </nz-card>
          </div>

          <!-- Cột phụ -->
          <div nz-col nzXs="24" nzLg="8">
             <!-- ... Các trường form phụ ... -->
            <nz-card nzTitle="Thông tin bổ sung">
              <!-- Mã Tour -->
              <nz-form-item>
                <nz-form-label>Mã Tour</nz-form-label>
                <nz-form-control>
                  <input nz-input formControlName="code" [placeholder]="!isEditMode ? 'Sẽ được tạo tự động' : ''" />
                </nz-form-control>
              </nz-form-item>

              <!-- Trạng thái -->
              <nz-form-item *ngIf="isEditMode">
                <nz-form-label>Trạng thái</nz-form-label>
                <nz-form-control>
                  <nz-select formControlName="tourStatus">
                    <nz-option nzValue="DRAFT" nzLabel="Bản nháp"></nz-option>
                    <nz-option nzValue="PUBLISHED" nzLabel="Công khai"></nz-option>
                    <nz-option nzValue="CANCELLED" nzLabel="Đã hủy"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>

              <!-- Số ngày -->
              <nz-form-item>
                <nz-form-label>Số ngày</nz-form-label>
                <nz-form-control>
                  <nz-input-number [ngModel]="durationDays" [ngModelOptions]="{standalone: true}" [nzDisabled]="true" class="w-full"></nz-input-number>
                </nz-form-control>
              </nz-form-item>

              <!-- Điểm khởi hành -->
              <nz-form-item>
                <nz-form-label nzRequired>Điểm khởi hành</nz-form-label>
                <nz-form-control nzErrorTip="Vui lòng chọn điểm khởi hành">
                  <nz-select formControlName="departLocationId" nzShowSearch nzPlaceHolder="Chọn điểm khởi hành">
                    <nz-option *ngFor="let loc of options.departures" [nzLabel]="loc.name" [nzValue]="loc.id"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </nz-card>
          </div>

          <!-- Phần chọn nhiều -->
          <div nz-col nzXs="24">
            <nz-card>
              <div nz-row [nzGutter]="16">
                <div nz-col nzSpan="12">
                  <nz-form-item>
                    <nz-form-label nzRequired>Điểm đến (chọn nhiều)</nz-form-label>
                    <nz-form-control nzErrorTip="Vui lòng chọn ít nhất một điểm đến">
                      <nz-select formControlName="destinationLocationIds" nzMode="multiple" nzPlaceHolder="Chọn các điểm đến">
                        <nz-option *ngFor="let dest of options.destinations" [nzLabel]="dest.name" [nzValue]="dest.id"></nz-option>
                      </nz-select>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div nz-col nzSpan="12">
                  <nz-form-item>
                    <nz-form-label nzRequired>Chủ đề (chọn nhiều)</nz-form-label>
                    <nz-form-control nzErrorTip="Vui lòng chọn ít nhất một chủ đề">
                      <nz-select formControlName="tourThemeIds" nzMode="multiple" nzPlaceHolder="Chọn các chủ đề">
                        <nz-option *ngFor="let theme of options.themes" [nzLabel]="theme.name" [nzValue]="theme.id"></nz-option>
                      </nz-select>
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>
            </nz-card>
          </div>

          <!-- THAY ĐỔI: Hiển thị thông tin yêu cầu của khách (nếu có) -->
          <div nz-col nzXs="24" *ngIf="isCustomRequestMode && (requestBookingDetail$ | async) as request">
            <nz-card nzTitle="Thông tin chi tiết từ Yêu cầu của Khách hàng">
              <nz-descriptions nzBordered [nzColumn]="{ xs: 1, sm: 2, md: 2, lg: 2, xl: 2, xxl: 2 }">
                <nz-descriptions-item nzTitle="Khách hàng">{{ request.customerName }}</nz-descriptions-item>
                <nz-descriptions-item nzTitle="Liên hệ">{{ request.customerPhone }} / {{ request.customerEmail }}</nz-descriptions-item>
                <nz-descriptions-item nzTitle="Hành trình">{{ request.startDate | date:'dd/MM/yyyy' }} - {{ request.endDate | date:'dd/MM/yyyy' }}</nz-descriptions-item>
                <nz-descriptions-item nzTitle="Ngân sách dự kiến">{{ request.priceMin | currency:'VND' }} - {{ request.priceMax | currency:'VND' }}</nz-descriptions-item>
                <nz-descriptions-item nzTitle="Số lượng khách" [nzSpan]="2">
                  Người lớn: <strong>{{ request.adults }}</strong> |
                  Trẻ em: <strong>{{ request.children }}</strong> |
                  Trẻ nhỏ: <strong>{{ request.infants }}</strong> |
                  Em bé: <strong>{{ request.toddlers }}</strong>
                </nz-descriptions-item>
                <nz-descriptions-item nzTitle="Lưu trú">
                  Số phòng: <strong>{{ request.hotelRooms }}</strong> - Loại: <strong>{{ request.roomCategory }}</strong>
                </nz-descriptions-item>
                <nz-descriptions-item nzTitle="Phương tiện">
                  <strong>{{ request.transport }}</strong>
                </nz-descriptions-item>
                <nz-descriptions-item nzTitle="Điểm đến chi tiết" [nzSpan]="2" class="whitespace-pre-wrap">
                  {{ request.destinationDetail || 'Không có ghi chú.' }}
                </nz-descriptions-item>
                <nz-descriptions-item nzTitle="Dịch vụ mong muốn" [nzSpan]="2" class="whitespace-pre-wrap">
                  {{ request.desiredServices || 'Không có yêu cầu đặc biệt.' }}
                </nz-descriptions-item>
              </nz-descriptions>
            </nz-card>
          </div>

        </div>
      </form>
    </ng-container>
  </nz-spin>
</div>
