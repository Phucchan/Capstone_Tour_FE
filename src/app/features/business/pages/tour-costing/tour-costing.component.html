<nz-spin [nzSpinning]="isLoading()">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <ng-container *ngIf="tourDetail() as tour">
        <nz-page-header [nzTitle]="'Chiết tính chi phí'" [nzSubtitle]="tour.name + ' (' + tour.code + ')'">
            <nz-page-header-extra>
                <button nz-button (click)="goBack()">
                    <span nz-icon nzType="arrow-left"></span>
                    Quay lại
                </button>
            </nz-page-header-extra>
        </nz-page-header>
    </ng-container>

    <!-- Main Grid Layout -->
    <div nz-row [nzGutter]="[24, 24]">
      <!-- Cột 1: Chi tiết chi phí dịch vụ -->
      <div nz-col nzXs="24" nzLg="8">
        <nz-card nzTitle="Chi tiết chi phí dịch vụ (Giá NET)" [nzExtra]="totalCostTpl">
          <ng-template #totalCostTpl>
            <div class="text-lg font-bold text-blue-600">{{ totalServiceCost() | currencyVnd }}</div>
          </ng-template>

          <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
            <div *ngFor="let group of groupedServices()" class="border-b pb-2 last:border-b-0">
              <h3 class="font-semibold text-gray-700">{{ group.name }}</h3>
              <ul class="text-sm text-gray-600 list-none p-0 mt-1">
                <li *ngFor="let service of group.services" class="flex justify-between">
                  <span>{{ service.partnerName }}</span>
                  <span class="font-medium">{{ service.nettPrice | currencyVnd }}</span>
                </li>
              </ul>
              <p class="text-right font-bold text-sm mt-1">Tổng: {{ group.total | currencyVnd }}</p>
            </div>
            <div *ngIf="groupedServices().length === 0">
              <nz-alert nzType="info" nzMessage="Chưa có dịch vụ nào được thêm vào lịch trình."></nz-alert>
            </div>
          </div>
           <div class="mt-4 border-t pt-4 text-xs text-gray-500">
            Tổng chi phí cố định: <strong class="text-gray-700">{{ costSummary()?.totalFixedCost | currencyVnd }}</strong>
            <br>
            Tổng chi phí/người: <strong class="text-gray-700">{{ costSummary()?.totalPerPersonCost | currencyVnd }}</strong>
          </div>
        </nz-card>
      </div>

      <!-- Cột 2: Bảng giá và công cụ tính -->
      <div nz-col nzXs="24" nzLg="16">
        <div class="space-y-6">
          <!-- Công cụ tính giá -->
          <nz-card nzTitle="Công cụ tính giá tự động">
            <form nz-form [formGroup]="priceToolForm" nzLayout="vertical">
              <div nz-row [nzGutter]="16">
                <div nz-col nzSpan="8">
                  <nz-form-item>
                    <nz-form-label nzRequired>Tỷ suất lợi nhuận (%)</nz-form-label>
                    <nz-form-control nzErrorTip="Vui lòng nhập số hợp lệ">
                      <nz-input-number formControlName="profitRate" [nzMin]="0" class="w-full"></nz-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div nz-col nzSpan="8">
                  <nz-form-item>
                    <nz-form-label nzRequired>Chi phí phát sinh/khách</nz-form-label>
                    <nz-form-control nzErrorTip="Vui lòng nhập số hợp lệ">
                       <nz-input-number formControlName="extraCost" [nzMin]="0" [nzStep]="1000" [nzFormatter]="formatterVND" [nzParser]="parserVND" class="w-full"></nz-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div nz-col nzSpan="8" class="flex items-end pb-6">
                  <button type="button" nz-button nzType="primary" (click)="applyAndSaveAllPrices()" [nzLoading]="isSubmitting()" [disabled]="priceToolForm.invalid" class="w-full">
                    <span nz-icon nzType="save"></span> Áp dụng & Lưu tất cả
                  </button>
                </div>
              </div>
            </form>
             <p class="text-xs text-gray-500 -mt-4">Lưu ý: Công cụ này sẽ tính toán và cập nhật giá cho tất cả các khoảng khách <strong class="text-red-500">không được nhập thủ công</strong>.</p>
          </nz-card>

          <!-- Bảng giá theo khoảng khách -->
          <nz-card nzTitle="Bảng giá theo khoảng khách (PAX)" [nzExtra]="addPaxButton">
            <ng-template #addPaxButton>
              <button type="button" nz-button nzType="primary" (click)="openPaxModal(paxModalContent)">
                <span nz-icon nzType="plus"></span>Thêm khoảng khách
              </button>
            </ng-template>

            <nz-table #paxTable [nzData]="paxConfigsWithPreview()" [nzFrontPagination]="false" [nzShowPagination]="false" nzSize="middle">
              <thead>
                <tr>
                  <th>Số khách</th>
                  <th nz-tooltip="Chi phí cố định/khách + Chi phí/người">Giá vốn/khách</th>
                  <th>Giá bán</th>
                  <th>Ghi chú</th>
                  <th nzAlign="right">Hành động</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pax of paxTable.data">
                  <td>{{ pax.minQuantity }} - {{ pax.maxQuantity }}</td>
                  <td>{{ pax.costPerPax | currencyVnd }}</td>
                  <td>
                    <strong class="text-green-600">{{ pax.previewSellingPrice | currencyVnd }}</strong>
                  </td>
                  <td>
                    <nz-tag *ngIf="pax.manualPrice" [nzColor]="'gold'">Giá thủ công</nz-tag>
                  </td>
                  <td nzAlign="right">
                    <a (click)="openPaxModal(paxModalContent, pax)">Sửa</a>
                    <nz-divider nzType="vertical"></nz-divider>
                    <a nz-popconfirm nzPopconfirmTitle="Bạn có chắc chắn muốn xóa?" (nzOnConfirm)="deletePax(pax.id)" class="text-red-500">Xóa</a>
                  </td>
                </tr>
              </tbody>
            </nz-table>
          </nz-card>
        </div>
      </div>
    </div>
  </div>
</nz-spin>

<!-- Template cho Modal thêm/sửa PAX -->
<ng-template #paxModalContent>
  <form nz-form [formGroup]="paxForm" class="mt-6">
    <div nz-row [nzGutter]="16">
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label nzRequired>Từ (khách)</nz-form-label>
          <nz-form-control nzErrorTip="Vui lòng nhập số khách">
            <nz-input-number formControlName="minQuantity" [nzMin]="1" class="w-full"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label nzRequired>Đến (khách)</nz-form-label>
          <nz-form-control [nzErrorTip]="maxQtyErrorTpl">
            <nz-input-number formControlName="maxQuantity" [nzMin]="1" class="w-full"></nz-input-number>
             <ng-template #maxQtyErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">Vui lòng nhập số khách</ng-container>
                <ng-container *ngIf="control.hasError('minMax')">Phải lớn hơn hoặc bằng số khách tối thiểu</ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
     <div *ngIf="paxForm.hasError('overlap')" class="mb-4">
        <nz-alert nzType="error" nzMessage="Khoảng khách này bị trùng với một khoảng đã có."></nz-alert>
    </div>

    <nz-divider></nz-divider>

    <nz-form-item>
      <nz-form-control>
        <label nz-checkbox formControlName="manualPrice">Tự nhập giá</label>
      </nz-form-control>
    </nz-form-item>

    <div nz-row [nzGutter]="16">
       <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label [nzRequired]="paxForm.get('manualPrice')?.value">Giá vốn/khách</nz-form-label>
          <nz-form-control nzErrorTip="Vui lòng nhập giá vốn">
            <nz-input-number formControlName="fixedPrice" class="w-full" [nzFormatter]="formatterVND" [nzParser]="parserVND"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label [nzRequired]="paxForm.get('manualPrice')?.value">Giá bán/khách</nz-form-label>
          <nz-form-control [nzErrorTip]="sellingPriceErrorTpl">
            <nz-input-number formControlName="sellingPrice" class="w-full" [nzFormatter]="formatterVND" [nzParser]="parserVND"></nz-input-number>
            <ng-template #sellingPriceErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">Vui lòng nhập giá bán</ng-container>
                <ng-container *ngIf="paxForm.hasError('priceInvalid')">Giá bán phải lớn hơn giá vốn</ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
  </form>
</ng-template>
