<!-- src/app/features/business/pages/request-booking-detail/request-booking-detail.component.html -->
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- THAY ĐỔI: Sử dụng viewData$ để lấy dữ liệu đã xử lý -->
  <ng-container *ngIf="viewData$ | async as view; else loading">
    <!-- Page Header -->
    <nz-page-header [nzGhost]="false" (nzBack)="goBack()" nzBackIcon>
      <nz-page-header-title>Yêu cầu từ: {{ view.request.customerName }}</nz-page-header-title>
      <nz-page-header-subtitle>#{{ view.request.id }}</nz-page-header-subtitle>
      <nz-page-header-tags>
        <nz-tag [nzColor]="getStatusClass(view.request.status)">{{ getStatusText(view.request.status) }}</nz-tag>
      </nz-page-header-tags>
      <nz-page-header-extra>
        <div *ngIf="view.request.status === RequestBookingStatus.PENDING" class="flex space-x-2">
          <button (click)="updateStatus(view.request.id, 'REJECTED')" nz-button nzDanger>Từ chối</button>
          <button (click)="updateStatus(view.request.id, 'ACCEPTED')" nz-button nzType="primary">Chấp nhận</button>
        </div>
        <div *ngIf="view.request.status === RequestBookingStatus.ACCEPTED">
          <button (click)="createTour(view.request.id)" nz-button nzType="primary">
            <i nz-icon nzType="plus-circle" nzTheme="outline"></i>
            Tạo Tour từ Yêu cầu
          </button>
        </div>
      </nz-page-header-extra>
    </nz-page-header>

    <!-- Details Grid -->
    <div class="mt-6" nz-row [nzGutter]="[16, 16]">
      <!-- Left Column -->
      <div nz-col [nzXs]="24" [nzLg]="16">
        <nz-card nzTitle="Chi tiết yêu cầu">
          <!-- THAY ĐỔI: Hiển thị đầy đủ thông tin -->
          <nz-descriptions nzBordered [nzColumn]="{ xs: 1, sm: 2, md: 2, lg: 2, xl: 2, xxl: 2 }">
            <nz-descriptions-item nzTitle="Hành trình">{{ view.request.startDate | date:'dd/MM/yyyy' }} - {{ view.request.endDate | date:'dd/MM/yyyy' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ngân sách dự kiến">{{ view.request.priceMin | currency:'VND' }} - {{ view.request.priceMax | currency:'VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Điểm khởi hành">{{ view.departureLocationName }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Điểm đến">{{ view.destinationLocationNames.join(', ') }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Chủ đề tour">{{ view.tourThemeNames.join(', ') }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số lượng khách">
              Người lớn: <strong>{{ view.request.adults }}</strong> |
              Trẻ em: <strong>{{ view.request.children }}</strong> |
              Trẻ nhỏ: <strong>{{ view.request.infants }}</strong> |
              Em bé: <strong>{{ view.request.toddlers }}</strong>
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Lưu trú">
              Số phòng: <strong>{{ view.request.hotelRooms }}</strong> - Loại: <strong>{{ view.request.roomCategory }}</strong>
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Phương tiện">
              <strong>{{ view.request.transport }}</strong>
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ghi chú điểm đến" [nzSpan]="2" class="whitespace-pre-wrap">
              {{ view.request.destinationDetail || 'Không có ghi chú.' }}
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Dịch vụ mong muốn" [nzSpan]="2" class="whitespace-pre-wrap">
              {{ view.request.desiredServices || 'Không có yêu cầu đặc biệt.' }}
            </nz-descriptions-item>
            <nz-descriptions-item *ngIf="view.request.reason" nzTitle="Lý do từ chối" [nzSpan]="2" class="whitespace-pre-wrap bg-red-50">
              <span class="text-red-700">{{ view.request.reason }}</span>
            </nz-descriptions-item>
          </nz-descriptions>
        </nz-card>
      </div>

      <!-- Right Column -->
      <div nz-col [nzXs]="24" [nzLg]="8">
        <nz-card nzTitle="Thông tin khách hàng">
          <nz-descriptions nzBordered [nzColumn]="1">
            <nz-descriptions-item nzTitle="Họ và tên">{{ view.request.customerName }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Email">{{ view.request.customerEmail }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Điện thoại">{{ view.request.customerPhone }}</nz-descriptions-item>
          </nz-descriptions>
        </nz-card>
      </div>
    </div>
  </ng-container>

  <ng-template #loading>
    <div class="text-center p-10">
      <nz-spin nzSimple nzSize="large"></nz-spin>
    </div>
  </ng-template>
</div>
