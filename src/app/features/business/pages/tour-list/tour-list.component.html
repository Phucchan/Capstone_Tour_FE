<div class="container mx-auto p-4 sm:p-6 lg:p-8">
  <nz-page-header nzTitle="Quản lý Tour">
    <nz-page-header-extra>
      <button nz-button nzType="primary" (click)="navigateToCreateTour()">
        <span nz-icon nzType="plus"></span>
        Tạo Tour mới
      </button>
    </nz-page-header-extra>
  </nz-page-header>

  <nz-card class="mb-4">
    <form nz-form [formGroup]="filterForm" nzLayout="vertical">
      <div nz-row [nzGutter]="16">
        <div nz-col nzSpan="8">
          <nz-form-item>
            <nz-form-label>Từ khóa</nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="keyword" placeholder="Nhập tên hoặc mã tour..." />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="8">
          <nz-form-item>
            <nz-form-label>Loại tour</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="tourType" nzAllowClear nzPlaceHolder="Tất cả các loại">
                <nz-option *ngFor="let type of tourTypes" [nzLabel]="type" [nzValue]="type"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="8">
          <nz-form-item>
            <nz-form-label>Trạng thái</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="tourStatus" nzAllowClear nzPlaceHolder="Tất cả trạng thái">
                <nz-option *ngFor="let status of tourStatuses" [nzLabel]="status" [nzValue]="status"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </form>
  </nz-card>

  <nz-table
    #tourTable
    [nzData]="tours"
    [nzLoading]="isLoading"
    [nzTotal]="totalRecords"
    [nzPageSize]="pageSize"
    [nzPageIndex]="pageIndex"
    (nzQueryParams)="onQueryParamsChange($event)"
    nzShowSizeChanger
    nzSize="middle"
  >
    <thead>
      <tr>
        <th>Tên Tour</th>
        <th>Số ngày</th>
        <th>Loại</th>
        <th>Trạng thái</th>
        <th nzAlign="right">Hành động</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let tour of tourTable.data">
        <td>
          <div class="flex items-center">
            <nz-avatar [nzSrc]="tour.thumbnailImage || 'https://placehold.co/40x40/EBF4FF/76A9FA?text=T'" nzShape="square"></nz-avatar>
            <span class="ml-3 font-medium">{{ tour.name }}</span>
          </div>
        </td>
        <td>{{ tour.durationDays }} ngày</td>
        <td>{{ tour.typeName }}</td>
        <td>
          <nz-tag [nzColor]="getStatusColor(tour.tourStatus)">{{ tour.tourStatus }}</nz-tag>
        </td>
        <td nzAlign="right">
          <!-- FIX: Corrected routerLink paths -->
          <a [routerLink]="['/business/tours', tour.id]">Chi tiết</a>
          <nz-divider nzType="vertical"></nz-divider>
          <a nz-dropdown [nzDropdownMenu]="menu" (click)="$event.stopPropagation()">
            Thêm
            <span nz-icon nzType="down"></span>
          </a>
          <nz-dropdown-menu #menu="nzDropdownMenu">
            <ul nz-menu>
              <li nz-menu-item>
                <a [routerLink]="['/business/tours', tour.id, 'schedule']">Lịch trình</a>
              </li>
              <li nz-menu-item>
                <a [routerLink]="['/business/tours', tour.id, 'costing']">Chiết tính</a>
              </li>
              <li nz-menu-item *ngIf="tour.tourStatus === 'PUBLISHED'">
                 <a [routerLink]="['/business/tours', tour.id, 'departure-dates']">Ngày khởi hành</a>
              </li>
            </ul>
          </nz-dropdown-menu>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>
