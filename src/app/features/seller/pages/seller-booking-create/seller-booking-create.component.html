<!-- Header -->
<div class="my-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
            Tạo Booking Mới
        </h2>
        <p class="text-sm text-gray-500">
            Hoàn thành các bước để tạo booking cho khách hàng.
        </p>
    </div>
    <a routerLink="/seller/dashboard"
        class="px-4 py-2 text-sm font-medium leading-5 text-gray-700 transition-colors duration-150 bg-gray-100 border border-transparent rounded-lg active:bg-gray-200 hover:bg-gray-200 focus:outline-none focus:shadow-outline-gray dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
        Hủy và Quay lại
    </a>
</div>

<!-- Stepper -->
<div class="w-full py-3 px-4 mb-8">
    <div class="flex">
        <div class="w-1/4">
            <div class="relative mb-2">
                <div class="w-10 h-10 mx-auto rounded-full text-lg flex items-center"
                    [ngClass]="currentStep >= 1 ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200 text-gray-500'">
                    <span class="text-center w-full">1</span>
                </div>
            </div>
            <div class="text-xs text-center md:text-base" [ngClass]="{'text-purple-600 font-semibold': currentStep >= 1}">Chọn Tour</div>
        </div>
        <div class="w-1/4">
            <div class="relative mb-2"><div class="absolute flex align-center items-center align-middle content-center" style="width: calc(100% - 2.5rem - 1rem); top: 50%; transform: translate(-50%, -50%)">
                <div class="w-full bg-gray-200 rounded items-center align-middle align-center flex-1">
                    <div class="w-0 bg-purple-300 py-1 rounded" [style.width.%]="currentStep > 1 ? 100 : 0"></div>
                </div>
            </div>
            <div class="w-10 h-10 mx-auto rounded-full text-lg flex items-center" [ngClass]="currentStep >= 2 ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200 text-gray-500'">
                <span class="text-center w-full">2</span></div>
            </div>
            <div class="text-xs text-center md:text-base" [ngClass]="{'text-purple-600 font-semibold': currentStep >= 2}">Chọn Lịch trình</div>
        </div>
        <div class="w-1/4">
            <div class="relative mb-2"><div class="absolute flex align-center items-center align-middle content-center" style="width: calc(100% - 2.5rem - 1rem); top: 50%; transform: translate(-50%, -50%)">
                <div class="w-full bg-gray-200 rounded items-center align-middle align-center flex-1">
                    <div class="w-0 bg-purple-300 py-1 rounded" [style.width.%]="currentStep > 2 ? 100 : 0"></div>
                </div>
            </div>
            <div class="w-10 h-10 mx-auto rounded-full text-lg flex items-center" [ngClass]="currentStep >= 3 ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200 text-gray-500'">
                <span class="text-center w-full">3</span></div>
            </div>
            <div class="text-xs text-center md:text-base" [ngClass]="{'text-purple-600 font-semibold': currentStep >= 3}">Thông tin Khách</div>
        </div>
        <div class="w-1/4">
            <div class="relative mb-2"><div class="absolute flex align-center items-center align-middle content-center" style="width: calc(100% - 2.5rem - 1rem); top: 50%; transform: translate(-50%, -50%)">
                <div class="w-full bg-gray-200 rounded items-center align-middle align-center flex-1">
                    <div class="w-0 bg-purple-300 py-1 rounded" [style.width.%]="currentStep > 3 ? 100 : 0"></div>
                </div>
            </div>
            <div class="w-10 h-10 mx-auto rounded-full text-lg flex items-center" [ngClass]="currentStep >= 4 ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200 text-gray-500'">
                <span class="text-center w-full">4</span></div>
            </div>
            <div class="text-xs text-center md:text-base" [ngClass]="{'text-purple-600 font-semibold': currentStep >= 4}">Xác nhận</div>
        </div>
    </div>
</div>


<!-- Form Content -->
<div class="px-4 py-3 mb-8 bg-white rounded-lg shadow-md dark:bg-gray-800">
    <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()">

        <!-- ===== STEP 1: CHỌN TOUR ===== -->
        <div [hidden]="currentStep !== 1">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Bước 1: Tìm và chọn Tour</h3>
            <div class="relative">
                <label class="block text-sm">
                    <span class="text-gray-700 dark:text-gray-400">Tìm kiếm tên tour</span>
                    <input [formControl]="tourSearchTerm"
                        class="block w-full mt-1 text-sm dark:text-gray-300 dark:border-gray-600 dark:bg-gray-700 form-input"
                        placeholder="Nhập ít nhất 2 ký tự để tìm tour...">
                </label>
                <div *ngIf="isSearchingTours" class="absolute right-2 top-8">
                    <!-- SỬA LỖI: Xóa thuộc tính [size] vì component không hỗ trợ -->
                    <app-spinner></app-spinner>
                </div>
                <!-- Search Results -->
                <div *ngIf="tourSearchResults.length > 0" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg dark:bg-gray-700 dark:border-gray-600">
                    <ul>
                        <li *ngFor="let tour of tourSearchResults" (click)="selectTour(tour)"
                            class="px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                            {{ tour.name }} ({{ tour.durationDays }} ngày)
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ===== STEP 2: CHỌN LỊCH TRÌNH ===== -->
        <div [hidden]="currentStep !== 2">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Bước 2: Chọn ngày khởi hành cho tour "{{ selectedTour?.name }}"</h3>
            <div *ngIf="isLoadingSchedules" class="flex justify-center"><app-spinner></app-spinner></div>
            <div *ngIf="!isLoadingSchedules && availableSchedules.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <label *ngFor="let schedule of availableSchedules" (click)="selectSchedule(schedule.id)"
                    class="p-4 border rounded-lg cursor-pointer transition-all"
                    [ngClass]="bookingForm.get('scheduleId')?.value === schedule.id ? 'border-purple-600 bg-purple-50 dark:bg-gray-700' : 'border-gray-300 dark:border-gray-600 hover:border-purple-400'">
                    <div class="font-semibold">{{ schedule.departureDate | formatDate }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Kết thúc: {{ schedule.endDate | formatDate }}</div>
                    <div class="text-sm text-green-600 dark:text-green-400">Còn {{ schedule.availableSeats }} chỗ</div>
                    <div class="text-sm font-bold text-purple-700 dark:text-purple-300 mt-1">{{ schedule.price | currencyVnd }}</div>
                </label>
            </div>
             <div *ngIf="!isLoadingSchedules && availableSchedules.length === 0" class="text-center text-gray-500">
                Tour này chưa có lịch trình khởi hành nào.
            </div>
        </div>

        <!-- ===== STEP 3: THÔNG TIN KHÁCH HÀNG ===== -->
        <div [hidden]="currentStep !== 3">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Bước 3: Điền thông tin người đặt và hành khách</h3>
            <!-- Booker Info -->
            <div formGroupName="bookerInfo" class="p-4 mb-6 border rounded-lg dark:border-gray-700">
                <h4 class="font-semibold mb-2">Thông tin người liên hệ</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Họ và tên</span><input type="text" formControlName="fullName" class="block w-full mt-1 text-sm form-input"></label>
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Email</span><input type="email" formControlName="email" class="block w-full mt-1 text-sm form-input"></label>
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Số điện thoại</span><input type="tel" formControlName="phone" class="block w-full mt-1 text-sm form-input"></label>
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Địa chỉ</span><input type="text" formControlName="address" class="block w-full mt-1 text-sm form-input"></label>
                </div>
            </div>
            <!-- Customers Info -->
            <div formArrayName="customers">
                <h4 class="font-semibold mb-2">Thông tin hành khách</h4>
                <div *ngFor="let customer of customers.controls; let i = index" [formGroupName]="i" class="p-4 mb-4 border rounded-lg dark:border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-4 relative">
                    <button type="button" (click)="removeCustomer(i)" *ngIf="customers.length > 1" class="absolute top-2 right-2 p-1 text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                    </button>
                    <label class="block text-sm md:col-span-3"><span class="text-gray-700 dark:text-gray-400">Họ và tên</span><input type="text" formControlName="fullName" class="block w-full mt-1 text-sm form-input"></label>
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Giới tính</span><select formControlName="gender" class="block w-full mt-1 text-sm form-select"><option value="MALE">Nam</option><option value="FEMALE">Nữ</option><option value="OTHER">Khác</option></select></label>
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Ngày sinh</span><input type="date" formControlName="dateOfBirth" class="block w-full mt-1 text-sm form-input"></label>
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Loại khách</span><select formControlName="paxType" class="block w-full mt-1 text-sm form-select"><option value="ADULT">Người lớn</option><option value="CHILD">Trẻ em</option><option value="INFANT">Trẻ nhỏ</option><option value="TODDLER">Em bé</option></select></label>
                    <div class="flex items-center mt-4"><input type="checkbox" formControlName="singleRoom" id="singleRoom-{{i}}" class="form-checkbox"><label for="singleRoom-{{i}}" class="ml-2 text-sm text-gray-700 dark:text-gray-400">Phòng đơn</label></div>
                </div>
            </div>
            <button type="button" (click)="addCustomer()" class="mt-2 px-4 py-2 text-sm font-medium leading-5 text-white transition-colors duration-150 bg-blue-600 border border-transparent rounded-lg active:bg-blue-600 hover:bg-blue-700">Thêm hành khách</button>
        </div>

        <!-- ===== STEP 4: XÁC NHẬN ===== -->
        <div [hidden]="currentStep !== 4">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Bước 4: Xác nhận thông tin Booking</h3>
            <!-- SỬA LỖI: Thêm *ngIf để đảm bảo selectedSchedule có giá trị -->
            <div *ngIf="selectedSchedule" class="p-4 border rounded-lg dark:border-gray-600 space-y-4">
                <div><h4 class="font-semibold">Thông tin Tour</h4>
                    <p><strong>Tour:</strong> {{ selectedTour?.name }}</p>
                    <p><strong>Ngày đi:</strong> {{ selectedSchedule.departureDate | formatDate }}</p>
                    <p><strong>Ngày về:</strong> {{ selectedSchedule.endDate | formatDate }}</p>
                </div>
                <div class="border-t dark:border-gray-500 pt-4"><h4 class="font-semibold">Thông tin người đặt</h4>
                    <p><strong>Họ tên:</strong> {{ bookerInfo.get('fullName')?.value }}</p>
                    <p><strong>Email:</strong> {{ bookerInfo.get('email')?.value }}</p>
                    <p><strong>SĐT:</strong> {{ bookerInfo.get('phone')?.value }}</p>
                </div>
                <div class="border-t dark:border-gray-500 pt-4"><h4 class="font-semibold">Danh sách hành khách ({{ customers.length }})</h4>
                    <ul class="list-disc list-inside">
                        <li *ngFor="let customer of customers.controls">{{ customer.get('fullName')?.value }} ({{ customer.get('paxType')?.value }})</li>
                    </ul>
                </div>
                <!-- Payment & Note -->
                <div class="border-t dark:border-gray-500 pt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Phương thức thanh toán</span><select formControlName="paymentMethod" class="block w-full mt-1 text-sm form-select"><option value="VNPAY">VNPAY</option><option value="CASH">Tiền mặt</option></select></label>
                    <label class="block text-sm"><span class="text-gray-700 dark:text-gray-400">Ghi chú</span><textarea formControlName="note" class="block w-full mt-1 text-sm form-textarea" rows="2"></textarea></label>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8">
            <button type="button" (click)="prevStep()" *ngIf="currentStep > 1"
                class="px-4 py-2 text-sm font-medium leading-5 text-gray-700 transition-colors duration-150 bg-gray-100 border border-transparent rounded-lg active:bg-gray-200 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                Quay lại
            </button>
            <div *ngIf="currentStep === 1"></div> <!-- Placeholder to keep Next button on the right -->

            <button type="button" (click)="nextStep()" *ngIf="currentStep < 4"
                [disabled]="(currentStep === 1 && !bookingForm.get('tourId')?.valid) || (currentStep === 2 && !bookingForm.get('scheduleId')?.valid) || (currentStep === 3 && (bookerInfo.invalid || customers.invalid))"
                class="px-4 py-2 text-sm font-medium leading-5 text-white transition-colors duration-150 bg-purple-600 border border-transparent rounded-lg active:bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Tiếp theo
            </button>

            <button type="submit" *ngIf="currentStep === 4" [disabled]="isSubmitting || bookingForm.invalid"
                class="px-4 py-2 text-sm font-medium leading-5 text-white transition-colors duration-150 bg-purple-600 border border-transparent rounded-lg active:bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <span *ngIf="!isSubmitting">Xác nhận và Tạo Booking</span>
                <span *ngIf="isSubmitting">Đang xử lý...</span>
            </button>
        </div>
    </form>
</div>
