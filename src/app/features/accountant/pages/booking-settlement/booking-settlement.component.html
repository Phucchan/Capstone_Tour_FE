<div class="mb-4">
    <a routerLink="/accountant/bookings" nz-button><i nz-icon nzType="arrow-left"></i> Quay lại danh sách</a>
</div>

<div *ngIf="isLoading" class="flex justify-center items-center h-full">
  <nz-spin nzSimple nzSize="large"></nz-spin>
</div>

<div *ngIf="!isLoading && detail">
  <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
      <h2 class="text-2xl font-semibold">Chi tiết Quyết toán Booking #{{ detail.bookingCode }}</h2>
      <div>
        <button nz-button (click)="openCreateBillModal('receipt')" nzType="primary" class="mr-2">
          <i nz-icon nzType="plus-circle" nzTheme="outline"></i> Tạo Phiếu Thu
        </button>
        <button nz-button (click)="openCreateBillModal('payment')" class="mr-2">
          <i nz-icon nzType="minus-circle" nzTheme="outline"></i> Tạo Phiếu Chi
        </button>
        <button nz-button nzType="default" (click)="completeBooking()" *ngIf="detail.status === 'CONFIRMED'" [nzLoading]="isProcessing" nzDanger>
          <i nz-icon nzType="check-square" nzTheme="outline"></i> Hoàn tất Booking
        </button>
      </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <nz-card nzTitle="Thông tin Booking">
        <nz-descriptions nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 2, sm: 2, xs: 1 }">
          <nz-descriptions-item nzTitle="Tên Tour">{{ detail.tourName }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Trạng thái">
            <nz-tag [nzColor]="getStatusColor(detail.status)">{{ detail.status }}</nz-tag>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Ngày đi">{{ detail.startDate | formatDate }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Ngày về">{{ detail.endDate | formatDate }}</nz-descriptions-item>
        </nz-descriptions>
      </nz-card>

      <nz-card nzTitle="Chi tiết Dịch vụ" class="mt-6">
        <div class="overflow-x-auto">
            <nz-table #serviceTable [nzData]="detail.services" nzSize="small" nzBordered [nzShowPagination]="false">
                <thead>
                    <tr>
                        <th>Tên Dịch vụ</th>
                        <th>Ngày</th>
                        <th>Số lượng (pax)</th>
                        <th>Giá nett</th>
                        <th>Giá bán</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let service of serviceTable.data">
                        <td>{{ service.serviceName }}</td>
                        <td>{{ service.dayNumber }}</td>
                        <td>{{ service.pax }}</td>
                        <td>{{ service.costPerPax | currencyVnd }}</td>
                        <td>{{ service.sellingPrice | currencyVnd }}</td>
                    </tr>
                </tbody>
            </nz-table>
        </div>
      </nz-card>
    </div>

    <div class="lg:col-span-1">
        <nz-tabset>
            <nz-tab nzTitle="Phiếu Thu">
                <app-bill-table
                    [bills]="detail.receiptBills"
                    (markPaid)="markBillAsPaid($event)">
                </app-bill-table>
            </nz-tab>
            <nz-tab nzTitle="Phiếu Chi">
                <app-bill-table
                    [bills]="detail.paymentBills"
                    (markPaid)="markBillAsPaid($event)">
                </app-bill-table>
            </nz-tab>
            <nz-tab nzTitle="Phiếu Hoàn tiền">
                <app-bill-table
                    [bills]="detail.refundBills"
                    (markPaid)="markBillAsPaid($event)">
                </app-bill-table>
            </nz-tab>
        </nz-tabset>
    </div>
  </div>
</div>
